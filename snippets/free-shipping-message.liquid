{% comment %}
  Free shipping message that integrates with currency converter
  Thresholds are set per currency in Theme Settings
{% endcomment %}

{%- assign message_id = 'free-shipping-message' -%}
{%- if section -%}
  {%- assign message_id = 'free-shipping-message-' | append: section.id -%}
{%- endif -%}

<p id="{{ message_id }}" class="free-shipping-message" style="display: none;">
  <span class="shipping-threshold-text"></span>
</p>

<script>
  // Free shipping message with currency converter integration
  (function () {
    const messageEl = document.getElementById('{{ message_id }}');
    if (!messageEl) return;

    // Thresholds from theme settings
    // -1 = hide message, 0 = free on all orders, >0 = threshold amount
    const thresholds = {
      GBP: {{ settings.threshold_gbp | default: -1 }},
      USD: {{ settings.threshold_usd | default: -1 }},
      EUR: {{ settings.threshold_eur | default: -1 }},
      AUD: {{ settings.threshold_aud | default: -1 }},
      NZD: {{ settings.threshold_nzd | default: -1 }},
      CNY: {{ settings.threshold_cny | default: -1 }},
      JPY: {{ settings.threshold_jpy | default: -1 }},
      AED: {{ settings.threshold_aed | default: -1 }},
    };

    // Message template from settings
    const messageTemplate = '{{ settings.free_shipping_message | default: "Free shipping on orders over [symbol][threshold]" }}';

    function updateShippingMessage() {
      if (!window.currencyConverter) {
        setTimeout(updateShippingMessage, 100);
        return;
      }

      const currency = window.currencyConverter.getCurrentCurrency();
      const threshold = thresholds[currency];

      // Hide if threshold is undefined, null, or negative (use -1 to hide)
      if (threshold === undefined || threshold === null || threshold < 0) {
        messageEl.style.display = 'none';
        return;
      }

      const symbol = window.currencyConverter.getCurrencySymbol(currency);

      // Format threshold with commas for thousands
      const formattedAmount = threshold.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');

      // Update message
      let message = messageTemplate;
      message = message.replace('[threshold]', formattedAmount);
      message = message.replace('[symbol]', symbol);

      const textEl = messageEl.querySelector('.shipping-threshold-text');
      if (textEl) {
        textEl.textContent = message;
        messageEl.style.display = '';
      }
    }

    // Update on currency change
    window.addEventListener('currency:changed', updateShippingMessage);

    // Initial update
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updateShippingMessage);
    } else {
      setTimeout(updateShippingMessage, 500);
    }
  })();
</script>
