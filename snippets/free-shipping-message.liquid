{% assign current_country = localization.country.iso_code %}
{% assign current_currency = cart.currency.iso_code | default: shop.currency %}
{% assign threshold = null %}
{% assign currency_symbol = null %}
{% assign setting_found = false %}

{% comment %}
  Split the shipping settings into lines
{% endcomment %}
{% capture newline %}
{% endcapture %}
{% assign shipping_settings = settings.shipping_settings | split: newline %}

{% comment %}
  Prepare a list of country and currency settings
{% endcomment %}
{% assign country_settings = '' %}
{% assign currency_settings = '' %}
{% for setting_line in shipping_settings %}
  {% assign setting_line = setting_line | strip %}
  {% if setting_line != '' %}
    {% assign setting_parts = setting_line | split: ':' %}
    {% if setting_parts.size == 3 %}
      {% assign code = setting_parts[0] | upcase %}
      {% assign threshold_value = setting_parts[1] %}
      {% assign symbol = setting_parts[2] %}
      {% if code.size == 2 %}
        {% comment %}
          Country code (ISO 3166-1 alpha-2 code)
        {% endcomment %}
        {% assign country_settings = country_settings
          | append: code
          | append: '|'
          | append: threshold_value
          | append: '|'
          | append: symbol
          | append: ','
        %}
      {% else %}
        {% comment %}
          Assume it's a currency code
        {% endcomment %}
        {% assign currency_settings = currency_settings
          | append: code
          | append: '|'
          | append: threshold_value
          | append: '|'
          | append: symbol
          | append: ','
        %}
      {% endif %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %}
  Split the settings into arrays
{% endcomment %}
{% assign country_settings = country_settings | split: ',' %}
{% assign currency_settings = currency_settings | split: ',' %}

{% comment %}
  Check for country-specific threshold
{% endcomment %}
{% for setting in country_settings %}
  {% assign setting_parts = setting | split: '|' %}
  {% if setting_parts[0] == current_country %}
    {% assign threshold = setting_parts[1] %}
    {% assign currency_symbol = setting_parts[2] %}
    {% assign setting_found = true %}
    {% break %}
  {% endif %}
{% endfor %}

{% unless setting_found %}
  {% comment %}
    Check for currency-specific threshold
  {% endcomment %}
  {% for setting in currency_settings %}
    {% assign setting_parts = setting | split: '|' %}
    {% if setting_parts[0] == current_currency %}
      {% assign threshold = setting_parts[1] %}
      {% assign currency_symbol = setting_parts[2] %}
      {% assign setting_found = true %}
      {% break %}
    {% endif %}
  {% endfor %}
{% endunless %}

{% unless setting_found %}
  {% comment %}
    Use default threshold and currency symbol
  {% endcomment %}
  {% assign threshold = settings.default_threshold %}
  {% assign currency_symbol = settings.default_currency %}
{% endunless %}

{% comment %}
  Output the free shipping message
{% endcomment %}
{% if setting_found %}
  <p id="free-shipping-message" class="free-shipping-message">
    {{ settings.free_shipping_message | replace: '[threshold]', threshold | replace: '[symbol]', currency_symbol }}
  </p>
{% endif %}
